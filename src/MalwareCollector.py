#!/usr/bin/python3.4

#import ConfigParser
import configparser
import tweepy
import sys
import requests


class MalwareCollector(object):
    def __init__(self, config=None, country=None, settings_filename='settings.cfg'):
        if country is None or country == 'brazil':
            self.country = 455819
            self.settingsFilename = settings_filename
            self.__readConfig()
            #consumer key, consumer secret
            self.auth = tweepy.OAuthHandler(self.consumer_key, self.consumer_secret_key)

            #access token, access token secret
            self.auth.set_access_token(self.access_token, self.access_secret_token)

            self.api = tweepy.API(self.auth)

            self.trends = None

    def __readConfig(self):
        try:
            config = configparser.ConfigParser()
            config.read(self.settingsFilename)
            self.consumer_key = config.get('twitter', 'consumer_key')
            self.consumer_secret_key = config.get('twitter', 'consumer_secret_key')
            self.access_token = config.get('twitter', 'access_token')
            self.access_secret_token = config.get('twitter', 'access_secret_token')
        except configparser.NoSectionError:
            sys.stderr.write("Could not open %s\n" % self.settingsFilename)
            sys.stderr.write("Exiting...\n")
            sys.exit(1)

    def printTrends(self):
        self.trends = self.api.trends_place(self.country)

        for trendsList in self.trends:
            for trend in trendsList['trends']:
                print(trend['name'])

    def getTrends(self):
        self.trends = self.api.trends_place(self.country)
        trendsName = []

        for trendsList in self.trends:
            for trend in trendsList['trends']:
                trendsName.append(trend['name'])
                #print(trend['name'])

        return trendsName

    def searchTweets(self, max_tweets=100, query=None):
        if query is None:
            print("Must define \'query\'!")
            sys.exit(1)
        else:
            #for tweet in tweepy.Cursor(api.search, q=('"good book"'), since='2014-09-16', until='2014-09-17').items(5):
            return [status._json for status in tweepy.Cursor(self.api.search, q=query, include_entities=True).items(max_tweets)]


if __name__ == "__main__":
    mc = MalwareCollector(country="brazil")
    myTrendsList = mc.getTrends()
    myTweets = mc.searchTweets2(query=myTrendsList[0], max_tweets=100)

    for tweets in myTweets:
        print(tweets['text'].encode('utf-8'))






